<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MYSQL-01 | 基础架构：一条SQL查询语句是如何执行的？</title>
      <link href="2020/12/24/MYSQL-01%20%20%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%EF%BC%9A%E4%B8%80%E6%9D%A1SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%9F/"/>
      <url>2020/12/24/MYSQL-01%20%20%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%EF%BC%9A%E4%B8%80%E6%9D%A1SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="MYSQL-01-基础架构：一条SQL查询语句是如何执行的？"><a href="#MYSQL-01-基础架构：一条SQL查询语句是如何执行的？" class="headerlink" title="MYSQL-01 | 基础架构：一条SQL查询语句是如何执行的？"></a>MYSQL-01 | 基础架构：一条SQL查询语句是如何执行的？</h1><h2 id="0-MYSQL慢查询"><a href="#0-MYSQL慢查询" class="headerlink" title="0 MYSQL慢查询"></a>0 MYSQL慢查询</h2><p>​        在web开发如此火爆的年代，数据库就成了我们开发中必不可少的一环。而使用数据库的绝大部分的时间是在单一的查询数据可，在大量的数据库查询中我们要尽可能的减少每一条的查询时间，而慢查询日志，就可以让我们在发现查询时间过长的SQL语句的时候对于查询为什么这么慢有很大帮助。</p><p>​        下面是MYSQL <strong>慢查询日志：（一次性，永久的要修改my文件）</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-- 查看慢查询日志是否打开</span><br><span class="line">show variables like &#39;%slow%&#39; ;</span><br><span class="line"></span><br><span class="line">-- 查看慢查询状态</span><br><span class="line">show global status like &#39;%slow%&#39;;</span><br><span class="line"> </span><br><span class="line">-- 打开慢查询日志</span><br><span class="line">set  @@global.slow_query_log &#x3D; ON;</span><br><span class="line"> </span><br><span class="line">-- 睡10s 测试慢查询</span><br><span class="line">select sleep(5) ;</span><br><span class="line"> </span><br><span class="line">-- 查看慢查询超时时间</span><br><span class="line">show variables like &#39;long_query%&#39;</span><br><span class="line"></span><br><span class="line">-- 设置慢查询时间，超过这个时间则记录入慢查询日志</span><br><span class="line">set long_query_time&#x3D;2</span><br><span class="line"></span><br><span class="line">-- 查看慢查询日志输出方式</span><br><span class="line">select @@global.log_output </span><br><span class="line"> </span><br><span class="line">-- 设置慢查询日志 table形式表示</span><br><span class="line">set @@global.log_output&#x3D;&#39;TABLE&#39;;</span><br><span class="line"> </span><br><span class="line">-- 查询慢查询日志</span><br><span class="line">select * from mysql.slow_log; </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="1-基本结构"><a href="#1-基本结构" class="headerlink" title="1 基本结构"></a>1 基本结构</h2><p>​        写这篇文章主要是想梳理一下MYSQL在执行一条SQL语句的时候发生的各种情况，MYSQL自己是怎么处理的。比如更新一条信息，根据（没有）主键查询信息。在以上的古城中数据库是怎样处理一下连带问题（权限，缓存，一致性，脏读和幻读的问题）。</p><p>​        </p><p>​        在MYSQL中一共可以大致的分成两层（不包括客户端）<strong>server层和存储引擎</strong>，而MYSQL的SQL语句主要是在<strong>server</strong>层进行处理。</p><img src="https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png" class="lazyload" data-srcset="https://static001.geekbang.org/resource/image/0d/d9/0d2070e8f84c4801adbfa03bda1f98d9.png" srcset="data:image/png;base64,666" alt="MYSQL基本零件" style="zoom: 33%;" align="middle" /><p>​        在上图的可以看出，基本上分为server层和存储引擎两个部分。</p><p>​        server层包括连接器、查询缓存（在8.0之后删除了）、分析器、优化器和执行器等，几乎包揽了MYSQL所有<strong>重要的核心功能，以及所有的内置函数。</strong>所有跨存储引擎的功能都在这一层实现，比如存储过程。触发器、视图等。</p><p>​        存储引擎负责<strong>数据的提取和存储</strong>功能。其架构是插件式（可更换），支持InnoDB、MyISAM、Memory等多个存储引擎，在MySQL 5.5.5版本开始默认InnoDB（在创建标时可以使用<code>engine=Memory</code>来使用你想要的存储引擎）。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from T where ID&#x3D;10；</span><br></pre></td></tr></table></figure><p>​        下面开始简单的解释一下上面的语句的执行流程。</p><h2 id="2-连接器"><a href="#2-连接器" class="headerlink" title="2 连接器"></a>2 连接器</h2><p>​        在MySQL执行上面的数据前，首先要创建一个链接，来连接数据库，这个时候就是连接器来起作用。连接器主要负责和用户<strong>建立链接，获取权限，维持和管理连接</strong>。连接命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h$ip -P$port -u$user -p -- 参数依次是数据库ip地址、端口号、用户名、密码</span><br></pre></td></tr></table></figure><p>​        连接命令中的mysql是客户端工具，用来和服务端建立连接。在完成经典的TCP三次握手后，连接器开始验证身份。</p><ul><li><p>如果用户名或密码错误，收到一个<code>ACCESS DENIED FOR USER</code> 的错误。</p></li><li><p>如果验证通过，<strong>连接器首先会去权限表查找你当前用户所持有的权限。之后的所有操作都依赖与这一次的权限查询</strong>。这也就意味着在当前连接没断开或者重新连接之前，管理员怎么修改当前用户的权限都不会起到效果，修改权限之后，只有在<em>下一次连接时才会生效</em></p><p>连接完成后如，如果你没有后续的动作，这个连接就处于空闲状态，你可以使用<code>show processlist</code>命令看到它，其中<code>sleep</code>表示连接在空闲状态</p></li></ul><p><img src="https://static001.geekbang.org/resource/image/f2/ed/f2da4aa3a672d48ec05df97b9f992fed.png" class="lazyload" data-srcset="https://static001.geekbang.org/resource/image/f2/ed/f2da4aa3a672d48ec05df97b9f992fed.png" srcset="data:image/png;base64,666"></p><p>​        如果空闲时间超过<code>wait_timeout</code>(最大空闲时间，默认值8小时)，自动断开连接。当断开连接后再去查询操作会返回<code>LOST CONNECTION TO MYSQL SERVER DURING QUERY</code> , 这时间你就需要重新连接，在执行当前请求了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#39;wait_timeout&#39;;</span><br></pre></td></tr></table></figure><h3 id="长短连接"><a href="#长短连接" class="headerlink" title="长短连接"></a>长短连接</h3><p>​        数据库中，长连接是连接成功后，执行几个请求后，还继续长时间保持这个连接，下一个请求继续使用。短连接是连接成功后，在执行几个查询之后就断开连接，下一个查询新建一个连接。</p><p>​        由于数据库中建立连接的过程非常浪费时间，所以建议使用长连接，减少短连接的使用。但由于大量使用长连接有时候会导致MySQL占用内存会越来越快，这是因为MySQL在执行过程中使用的内存是管理在连接对象里面的，这些资源会在连接断开的时候释放。长连接积累下来，导致内存占用过大，被系统前置杀掉（OOM），从现象看就是MySQL异常重启。</p><p>​        解决上面的问题你可以用以下的两种方案：</p><ol><li>定期断开长连接。使用一段时间，或者程序里面判断一个占用内存过比较大的操作后，断开连接，之后查询重连。</li><li>在MySQL 5.7或之后的版本中，你可以每次执行一个比较大的操作后使用<code>mysql_reset_connection</code>来初始化连接资源。这个过程不需要重连和重新做权限验证，但可以恢复到连接刚刚建立时的状态。</li></ol><h2 id="3-查询缓存"><a href="#3-查询缓存" class="headerlink" title="3 查询缓存"></a>3 查询缓存</h2><p>​        </p>]]></content>
      
      
      <categories>
          
          <category> MYSQL_深度解析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MYSQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>My New Post</title>
      <link href="2020/12/22/My-New-Post/"/>
      <url>2020/12/22/My-New-Post/</url>
      
        <content type="html"><![CDATA[<h2 id="Hexo文章初步建设"><a href="#Hexo文章初步建设" class="headerlink" title="Hexo文章初步建设"></a>Hexo文章初步建设</h2><ol><li><p>新建文章命令 <code>hexo new post postname</code> </p><p>文章生成目录存在于blog/scourse/</p><p>win、IOS系统使用markdown软件打开编辑，命令行使用vim</p></li><li><p>文章生成 <code>hexo g</code></p></li><li><p>文章发布 <code>hexo d</code></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="2020/12/22/hello-world/"/>
      <url>2020/12/22/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
